<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/style.css">
    <script src="static/config.js"></script>
    <script src="static/site_config.js"></script>
</head>

<body>
    <div class="container">
        <h2 id="pageTitle">Admin Control Panel</h2>
        <div class="status">
            <p><strong id="queueStatusLabel">Queue status:</strong> <span id="queueStatus">Loading...</span></p>
            <p><strong id="readyPoolLabel">Ready pool:</strong> <span id="readyPoolLimit">Disabled</span></p>
            <p><strong id="guestCountLabel">Guests in queue:</strong> <span id="guestCount">0</span></p>
            <p><strong id="venueStatusLabel">Guests in venue:</strong> <span id="guestsInVenue">Loading...</span></p>
            <p><strong id="premiumLimitLabel">Premium limit:</strong> <span id="premiumLimit">Loading...</span></p>
            <p><strong id="oneShotPriceLabel">One Shot price:</strong> $<span id="oneShotPrice">Loading...</span></p>
        </div>
        <button class="btn btn-success" onclick="openQueue()">Open Queue</button>
        <button class="btn btn-danger" onclick="closeQueue()">Close Queue</button>
        <button class="btn btn-warning" onclick="resetQueue()">Reset Queue</button>

        <hr>

        <h3 id="demoModeLabel">Demo mode</h3>

        <input type="number" id="mockCount" placeholder="Number of mock guests">
        <button class="btn btn-primary" onclick="mockGuests()">Insert Mock Guests</button>

        <hr>

        <h3 id="premiumAccessLabel">Premium access</h3>

        <input type="number" id="premiumLimitInput" placeholder="Set Premium Limit">
        <button class="btn btn-primary" onclick="setPremiumLimit()">Update Premium Limit</button>

        <input type="number" id="oneShotPriceInput" placeholder="Set One Shot Price ($)">
        <button class="btn btn-primary" onclick="setOneShotPrice()">Update One Shot Price</button>

        <hr>

        <h3 id="venueManagementLabel">Venue management</h3>

        <label>
            <input type="checkbox" id="venueModeToggle" onchange="toggleVenueMode()">
            <span id="enableVenueModeLabel">Enable Venue Mode</span>
        </label>

        <br><br>

        <input type="number" id="venueCapacityInput" placeholder="Set Venue Capacity">
        <button class="btn btn-primary" onclick="setVenueCapacity()">Update Venue Capacity</button>

        <hr>

        <h3 id="readyPoolLabel">Ready pool</h3>
        <p><strong id="currentReadyPoolLabel">Current ready pool:</strong> <span id="readyPoolLimit">Disabled</span></p>
        <input type="number" id="readyPoolLimitInput" placeholder="Set Ready Pool Size (0 to disable)">
        <button class="btn btn-primary" onclick="setReadyPoolLimit()">Update Ready Pool</button>

        <hr>

        <h3 id="siteConfigurationLabel">Site Configuration</h3>
        <p>Customize branding, colors, and text for different customers.</p>
        <button class="btn btn-primary" onclick="openSiteConfigCMS()" id="openCMSBtn">Open Configuration CMS</button>

    </div>

    <script>
        const API_BASE = (window.API_BASE || '').replace(/\/$/, '');
        const api = (path) => `${API_BASE}${path}`;

        async function fetchStatus() {
            const res = await fetch(api('/status'));
            const data = await res.json();
            console.log(data); // for debug
            document.getElementById('queueStatus').textContent = data.is_open ? 'Open' : 'Closed';
            document.getElementById('guestCount').textContent = data.queue.length;
            document.getElementById('premiumLimit').textContent = data.premium_limit;
            document.getElementById('oneShotPrice').textContent = data.one_shot_price;

            // New venue-related updates
            document.getElementById('venueModeToggle').checked = data.venue_mode_enabled;
            document.getElementById('guestsInVenue').textContent = data.guests_in_venue

            // Ready pool updates
            const limit = data.ready_pool_limit || 0;
            document.getElementById('readyPoolLimit').textContent = limit > 0 ? limit : 'Disabled';

        }

        async function openQueue() {
            await fetch(api('/open'), { method: 'POST' });
            fetchStatus();
        }

        async function closeQueue() {
            await fetch(api('/close'), { method: 'POST' });
            fetchStatus();
        }

        async function resetQueue() {
            await fetch(api('/reset'), { method: 'POST' });
            fetchStatus();
        }

        async function mockGuests() {
            const count = document.getElementById('mockCount').value;
            if (count > 0) {
                await fetch(api(`/mock-guests/${count}`), { method: 'POST' });
                fetchStatus();
            }
        }

        async function setPremiumLimit() {
            const limit = document.getElementById('premiumLimitInput').value;
            if (limit >= 0) {
                await fetch(api('/set-premium-limit'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit: parseInt(limit) })
                });
                fetchStatus();
            }
        }

        async function setOneShotPrice() {
            const price = document.getElementById('oneShotPriceInput').value;
            if (price >= 0) {
                await fetch(api('/set-one-shot-price'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ price: parseInt(price) })
                });
                fetchStatus();
            }
        }

        async function toggleVenueMode() {
            const enabled = document.getElementById('venueModeToggle').checked;
            await fetch(api('/set-venue-mode'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled })
            });
            fetchStatus();
        }

        async function setVenueCapacity() {
            const capacity = document.getElementById('venueCapacityInput').value;
            if (capacity >= 0) {
                await fetch(api('/set-venue-capacity'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ capacity: parseInt(capacity) })
                });
                fetchStatus();
            }
        }

        async function setReadyPoolLimit() {
            const limit = document.getElementById('readyPoolLimitInput').value;
            if (limit >= 0) {
                await fetch(api('/set-ready-pool-limit'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit: parseInt(limit) })
                });
                fetchStatus();
            }
        }

        function openSiteConfigCMS() {
            window.open('site_config_cms.html', '_blank');
        }


        // Apply site configuration
        applySiteConfig();
        
        fetchStatus();
        setInterval(fetchStatus, 5000);

        // Apply site configuration to UI elements
        function applySiteConfig() {
            // Branding
            document.title = getConfig('brand.name', 'Admin Control Panel');
            
            // Text content
            document.getElementById('pageTitle').textContent = getConfig('text.adminTitle', 'Admin Control Panel');
            document.getElementById('queueStatusLabel').textContent = getConfig('text.queueStatus', 'Queue status:');
            document.getElementById('readyPoolLabel').textContent = getConfig('text.readyPool', 'Ready pool:');
            document.getElementById('guestCountLabel').textContent = getConfig('text.guestCount', 'Guests in queue:');
            document.getElementById('venueStatusLabel').textContent = getConfig('text.venueStatus', 'Guests in venue:');
            document.getElementById('premiumLimitLabel').textContent = getConfig('text.premiumLimit', 'Premium limit:');
            document.getElementById('oneShotPriceLabel').textContent = getConfig('text.oneShotPrice', 'One Shot price:');
            document.getElementById('siteConfigurationLabel').textContent = getConfig('text.siteConfigurationLabel', 'Site Configuration');
            document.getElementById('openCMSBtn').textContent = getConfig('text.openCMSBtn', 'Open Configuration CMS');
            
            // Apply colors if CSS custom properties are supported
            if (CSS.supports('color', 'var(--custom-property)')) {
                document.documentElement.style.setProperty('--primary-color', getConfig('colors.primary', '#007bff'));
                document.documentElement.style.setProperty('--secondary-color', getConfig('colors.secondary', '#6c757d'));
                document.documentElement.style.setProperty('--success-color', getConfig('colors.success', '#28a745'));
                document.documentElement.style.setProperty('--danger-color', getConfig('colors.danger', '#dc3545'));
            }
        }
    </script>
</body>

</html>