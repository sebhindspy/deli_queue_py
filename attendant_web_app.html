<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Team Member App</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="stylesheet" href="static/style.css">
    <script src="static/config.js"></script>
    <script src="static/site_config.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

</head>

<body>
    <div class="info">
        <h1 id="pageTitle">Venue Entry App</h1>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px;"><em>Last sync: <span id="lastUpdateTime">Never</span></em></p>

        <div id="reader"></div>
        <div id="scanner-status" style="text-align: center; margin: 10px 0; color: #666; font-size: 0.9rem;">Initializing scanner...</div>
        <div id="result"></div>

        <div class="status">
            <p><strong id="queueStatusLabel">Queue status:</strong> <span id="queueStatus">Loading...</span></p>
            <p><strong id="guestCountLabel">Guests in queue:</strong> <span id="guestCount">0</span></p>
            <p><strong id="venueStatusLabel">Venue status:</strong> <span id="venueStatus">Loading...</span></p>
            <p><strong id="nextGuestLabel">Next guest:</strong> <span id="nextGuest">Loading..</span><span id="premiumBadge"></span></p>
            <p><strong id="readyPoolLabel">Ready pool:</strong></p>
            <ul id="readyPoolList"></ul>
            
        </div>

        <button id="advanceBtn" onclick="advanceQueue()"></button>
        <button id="refreshScannerBtn" onclick="refreshScanner()" style="background-color: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;">Refresh Scanner</button>
        <button id="cameraSelectBtn" onclick="showCameraSelection()" style="background-color: #17a2b8; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;">Select Camera</button>
        <button id="refreshStatusBtn" onclick="fetchStatus()" style="background-color: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;">Refresh Status</button>
        <button id="forceRefreshBtn" onclick="forceRefreshStatus()" style=" background-color: #ffc107; color: #212529; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;">Force Refresh</button>
    </div>
    <script>
        const API_BASE = (window.API_BASE || '').replace(/\/$/, '');
        const api = (path) => `${API_BASE}${path}`;

        async function fetchStatus() {
            try {
                const response = await fetch(api('/status'));
                const data = await response.json();
                
                // Check for sudden queue changes
                const currentGuestCount = data.queue ? data.queue.length : 0;
                if (window.lastGuestCount !== undefined && window.lastGuestCount !== currentGuestCount) {
                    console.warn(`ðŸš¨ QUEUE COUNT CHANGED: ${window.lastGuestCount} â†’ ${currentGuestCount} at ${new Date().toLocaleTimeString()}`);
                    console.warn('This might indicate automatic queue clearing or another process modifying the queue');
                    
                    // Log the full response to see what changed
                    console.log('Full response when queue changed:', data);
                }
                window.lastGuestCount = currentGuestCount;

                // Fix: Use data.queue.length instead of data.queue.length
                const guestCount = data.queue ? data.queue.length : 0;
                const guestCountElement = document.getElementById('guestCount');
                guestCountElement.textContent = guestCount;
                
                // Add visual feedback for status updates
                guestCountElement.style.backgroundColor = '#e8f5e8';
                setTimeout(() => {
                    guestCountElement.style.backgroundColor = '';
                }, 500);
                
                document.getElementById('queueStatus').textContent = data.is_open ? 'Open' : 'Closed';

                const isFull = data.venue_mode_enabled && data.guests_in_venue >= data.venue_capacity;
                const venueStatusText = data.venue_mode_enabled ? (isFull ? 'Full' : 'Available') : 'Disabled';
                
                document.getElementById('venueStatus').textContent = venueStatusText;
                
                // Add visual indicator for venue mode changes
                const venueStatusElement = document.getElementById('venueStatus');
                if (data.venue_mode_enabled) {
                    venueStatusElement.style.color = isFull ? '#dc3545' : '#28a745'; // Red if full, green if available
                } else {
                    venueStatusElement.style.color = '#6c757d'; // Gray if disabled
                }

                const advanceBtn = document.getElementById('advanceBtn');

                const readyPool = Array.isArray(data.ready_pool) ? data.ready_pool : [];
                const readyPoolCount = readyPool.length;

                if (data.queue && data.queue.length > 0 && !isFull) {
                    const nextGuest = readyPool.length > 0 ? readyPool[0] : data.queue[0];
                    const email = typeof nextGuest === 'object' && nextGuest.email ? nextGuest.email : String(nextGuest);
                    const isPremium = typeof nextGuest === 'object' && nextGuest.premium;

                    document.getElementById('nextGuest').textContent = email;
                    document.getElementById('premiumBadge').textContent = isPremium ? 'Premium' : '';
                    document.getElementById('premiumBadge').className = isPremium ? 'premium-badge' : '';
                    advanceBtn.disabled = false;
                } else {
                    document.getElementById('nextGuest').textContent = 'None';
                    document.getElementById('premiumBadge').textContent = '';
                    document.getElementById('premiumBadge').className = '';
                    advanceBtn.disabled = true;
                }

                const readyPoolList = document.getElementById('readyPoolList');
                readyPoolList.innerHTML = '';
                readyPool.forEach(g => {
                    const li = document.createElement('li');
                    const email = typeof g === 'object' && g.email ? g.email : String(g);
                    li.textContent = email + (g.premium ? ' (Premium)' : '');
                    readyPoolList.appendChild(li);
                });
                
                // Show last update time
                const now = new Date();
                const timeString = now.toLocaleTimeString();
                document.getElementById('lastUpdateTime').textContent = timeString;
                
            } catch (error) {
                console.error('Error fetching status:', error);
                // Set default values on error
                document.getElementById('guestCount').textContent = 'Error';
                document.getElementById('queueStatus').textContent = 'Error';
                document.getElementById('venueStatus').textContent = 'Error';
                document.getElementById('nextGuest').textContent = 'Error';
            }
        }



        async function advanceQueue() {
            try {
                console.log('Advancing queue...'); // Debug log
                
                const response = await fetch(api('/advance'), { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    console.log('Queue advanced successfully:', result); // Debug log
                    
                    // Show success message
                    document.getElementById("result").innerText = "Guest removed from queue successfully";
                    setTimeout(() => {
                        document.getElementById("result").innerText = "";
                    }, 2000);
                    
                    // Refresh status to show updated queue
                    await fetchStatus();
                } else {
                    const error = await response.json();
                    console.error('Failed to advance queue:', error); // Debug log
                    alert(error.detail || getConfig('text.failedToAdvanceQueue', 'Failed to advance queue.'));
                }
            } catch (error) {
                console.error('Error advancing queue:', error);
                alert(getConfig('text.networkErrorAdvancing', 'Network error occurred while advancing queue.'));
            }
        }

        // Apply site configuration
        applySiteConfig();
        
        // Initial status fetch
        fetchStatus();
        
        // Refresh status every 3 seconds
        setInterval(fetchStatus, 3000);
        
        // Also refresh status when page becomes visible (user returns to tab)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('Page became visible, refreshing status...');
                fetchStatus();
            }
        });

        // Force refresh function for immediate status update
        function forceRefreshStatus() {
            console.log('Force refresh triggered...');
            // Clear any cached data
            window.lastGuestCount = undefined;
            // Force immediate status fetch
            fetchStatus();
        }

        // Apply site configuration to UI elements
        function applySiteConfig() {
            // Branding
            document.title = getConfig('brand.name', 'Venue Entry App');
            
            // Text content
            document.getElementById('pageTitle').textContent = getConfig('text.attendantTitle', 'Venue Entry App');
            document.getElementById('venueStatusLabel').textContent = getConfig('text.venueStatus', 'Venue status:');
            document.getElementById('queueStatusLabel').textContent = getConfig('text.queueStatus', 'Queue status:');
            document.getElementById('guestCountLabel').textContent = getConfig('text.guestCount', 'Guests in queue:');
            document.getElementById('nextGuestLabel').textContent = getConfig('text.nextGuest', 'Next guest:');
            document.getElementById('readyPoolLabel').textContent = getConfig('text.readyPool', 'Ready pool:');
            document.getElementById('advanceBtn').textContent = getConfig('text.removeGuest', 'Remove guest from queue');
            
            // Apply colors if CSS custom properties are supported
            if (CSS.supports('color', 'var(--custom-property)')) {
                document.documentElement.style.setProperty('--primary-color', getConfig('colors.primary', '#007bff'));
                document.documentElement.style.setProperty('--secondary-color', getConfig('colors.secondary', '#6c757d'));
                document.documentElement.style.setProperty('--success-color', getConfig('colors.success', '#28a745'));
                document.documentElement.style.setProperty('--danger-color', getConfig('colors.danger', '#dc3545'));
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            // Prevent multiple scans of the same code
            if (window.lastScannedCode === decodedText) {
                console.log('Code already scanned, ignoring duplicate');
                return;
            }
            
            window.lastScannedCode = decodedText;
            
            // Update scanner status
            document.getElementById('scanner-status').textContent = 'Processing scan...';
            document.getElementById('scanner-status').style.color = '#ffc107';
            
            document.getElementById("result").innerText = `Scanned Email: ${decodedText}`;

            try {
                const response = await fetch(api('/scan'), { 
                    method: "POST", 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ email: decodedText }) 
                });
                
                if (response.ok) {
                    document.getElementById("result").innerText = "Guest scanned successfully";
                    // Refresh status after successful scan
                    fetchStatus();
                    
                    // Clear the result after a delay
                    setTimeout(() => {
                        document.getElementById("result").innerText = "";
                        // Reset the last scanned code to allow re-scanning
                        window.lastScannedCode = null;
                        // Update scanner status back to ready
                        document.getElementById('scanner-status').textContent = 'Scanner ready - Point camera at QR code';
                        document.getElementById('scanner-status').style.color = '#28a745';
                    }, 3000);
                } else {
                    const error = await response.json();
                    document.getElementById("result").innerText = `Scan failed: ${error.detail || "Unknown error"}`;
                    
                    // Clear the result after a delay
                    setTimeout(() => {
                        document.getElementById("result").innerText = "";
                        // Reset the last scanned code to allow re-scanning
                        window.lastScannedCode = null;
                        // Update scanner status back to ready
                        document.getElementById('scanner-status').textContent = 'Scanner ready - Point camera at QR code';
                        document.getElementById('scanner-status').style.color = '#28a745';
                    }, 3000);
                }
            } catch (err) {
                console.error("Error scanning guest:", err);
                document.getElementById("result").innerText = "Network error occurred";
                
                // Clear the result after a delay
                setTimeout(() => {
                    document.getElementById("result").innerText = "";
                    // Reset the last scanned code to allow re-scanning
                    window.lastScannedCode = null;
                    // Update scanner status back to ready
                    document.getElementById('scanner-status').textContent = 'Scanner ready - Point camera at QR code';
                    document.getElementById('scanner-status').style.color = '#28a745';
                }, 3000);
            }

            // Don't restart the scanner - let it continue scanning
            // This prevents the flickering and error states
        }

        // Handle scanner errors gracefully
        function handleScannerError(error) {
            console.error('Scanner error:', error);
            const readerElement = document.getElementById("reader");
            
            if (error.name === 'NotAllowedError') {
                readerElement.innerHTML = "<p>" + getConfig('text.cameraAccessDenied', 'Camera access denied. Please allow camera access and refresh the scanner.') + "</p>";
            } else if (error.name === 'NotFoundError') {
                readerElement.innerHTML = "<p>" + getConfig('text.noCameraFound', 'No camera found. Please connect a camera and refresh the scanner.') + "</p>";
            } else if (error.name === 'NotSupportedError') {
                readerElement.innerHTML = "<p>" + getConfig('text.cameraNotSupported', 'Camera not supported. Please try a different device or browser.') + "</p>";
            } else {
                readerElement.innerHTML = "<p>" + getConfig('text.scannerError', 'Scanner error occurred. Please refresh the scanner.') + "</p>";
            }
        }

        // Get available cameras and help user select the right one
        async function getAvailableCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                console.log('Available cameras:', videoDevices);
                
                // On mobile, try to find back camera
                const backCamera = videoDevices.find(device => 
                    device.label.toLowerCase().includes('back') || 
                    device.label.toLowerCase().includes('rear') ||
                    device.label.toLowerCase().includes('environment')
                );
                
                if (backCamera) {
                    console.log('Found back camera:', backCamera.label);
                    return backCamera.deviceId;
                }
                
                // Fallback to first available camera
                if (videoDevices.length > 0) {
                    console.log('Using first available camera:', videoDevices[0].label);
                    return videoDevices[0].deviceId;
                }
                
                return null;
            } catch (error) {
                console.error('Error getting cameras:', error);
                return null;
            }
        }

        // Initialize the QR scanner
        function initializeScanner() {
            try {
                // Update status
                document.getElementById('scanner-status').textContent = 'Initializing scanner...';
                document.getElementById('scanner-status').style.color = '#ffc107';
                
                // Clear any existing scanner content
                const readerElement = document.getElementById("reader");
                readerElement.innerHTML = '';
                
                if (window.html5QrcodeScanner) {
                    // Clean up existing scanner
                    try {
                        window.html5QrcodeScanner.clear();
                        window.html5QrcodeScanner = null;
                    } catch (error) {
                        console.log('Scanner already cleared or null');
                    }
                }
                
                // Wait for DOM to be ready and then initialize
                setTimeout(() => {
                    try {
                        // Check if camera permissions are available
                        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                            // Request camera permission first
                            navigator.mediaDevices.getUserMedia({ video: true })
                                .then(stream => {
                                    // Camera permission granted, now create scanner
                                    createScanner();
                                    // Stop the test stream
                                    stream.getTracks().forEach(track => track.stop());
                                })
                                .catch(permissionError => {
                                    console.error('Camera permission error:', permissionError);
                                    if (permissionError.name === 'NotAllowedError') {
                                        readerElement.innerHTML = "<p>" + getConfig('text.cameraAccessDenied', 'Camera access denied. Please allow camera access and refresh the scanner.') + "</p>";
                                        document.getElementById('scanner-status').textContent = 'Camera access denied';
                                        document.getElementById('scanner-status').style.color = '#dc3545';
                                    } else if (permissionError.name === 'NotFoundError') {
                                        readerElement.innerHTML = "<p>" + getConfig('text.noCameraFound', 'No camera found. Please connect a camera and refresh the scanner.') + "</p>";
                                        document.getElementById('scanner-status').textContent = 'No camera found';
                                        document.getElementById('scanner-status').style.color = '#dc3545';
                                    } else {
                                        readerElement.innerHTML = "<p>" + getConfig('text.cameraError', 'Camera error: {error}').replace('{error}', permissionError.message) + "</p>";
                                        document.getElementById('scanner-status').textContent = 'Camera error';
                                        document.getElementById('scanner-status').style.color = '#dc3545';
                                    }
                                });
                        } else {
                            // Fallback for older browsers
                            createScanner();
                        }
                    } catch (error) {
                        console.error('Error in scanner setup:', error);
                                                    readerElement.innerHTML = "<p>" + getConfig('text.scannerSetupError', 'Error setting up scanner. Please try refreshing the scanner.') + "</p>";
                        document.getElementById('scanner-status').textContent = 'Setup error';
                        document.getElementById('scanner-status').style.color = '#dc3545';
                    }
                }, 200);
                
            } catch (error) {
                console.error('Error in scanner initialization:', error);
                                        document.getElementById("reader").innerHTML = "<p>" + getConfig('text.scannerInitError', 'Error initializing QR scanner. Please refresh the page.') + "</p>";
                document.getElementById('scanner-status').textContent = 'Initialization failed';
                document.getElementById('scanner-status').style.color = '#dc3545';
            }
        }

        // Create the actual scanner after permissions are granted
        function createScanner() {
            try {
                const readerElement = document.getElementById("reader");
                
                // Better configuration for mobile and desktop
                const scannerConfig = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 },
                    rememberLastUsedCamera: true,
                    showTorchButtonIfSupported: true,
                    disableFlip: false,
                    verbose: false,
                    // Better mobile support
                    aspectRatio: 1.0,
                    // Try to use back camera on mobile
                    supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
                };
                
                const scanner = new Html5QrcodeScanner("reader", scannerConfig);
                
                // Use a more robust error handler
                scanner.render(onScanSuccess, (error) => {
                    // Only show errors for actual camera/permission issues, not parsing errors
                    if (error.name === 'NotAllowedError' || 
                        error.name === 'NotFoundError' || 
                        error.name === 'NotSupportedError' ||
                        error.name === 'NotReadableError') {
                        handleScannerError(error);
                    } else {
                        // For parsing errors, just log them but don't show to user
                        console.log('Scanner parsing error (normal):', error.message);
                    }
                });
                
                window.html5QrcodeScanner = scanner;
                console.log('QR Scanner created successfully');
                
                // Update status to ready
                document.getElementById('scanner-status').textContent = 'Scanner ready - Point camera at QR code';
                document.getElementById('scanner-status').style.color = '#28a745';
                
            } catch (error) {
                console.error('Error creating scanner:', error);
                                        document.getElementById("reader").innerHTML = "<p>" + getConfig('text.scannerCreateError', 'Error creating QR scanner. Please try refreshing the scanner.') + "</p>";
                document.getElementById('scanner-status').textContent = 'Scanner creation failed';
                document.getElementById('scanner-status').style.color = '#dc3545';
            }
        }

        function refreshScanner() {
            initializeScanner();
        }

        // Show camera selection dialog
        async function showCameraSelection() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length === 0) {
                    alert(getConfig('text.noCamerasFound', 'No cameras found'));
                    return;
                }
                
                // Create camera selection dialog
                const cameraNames = videoDevices.map(device => device.label || `Camera ${device.deviceId.slice(0, 8)}`);
                const selectedIndex = prompt(
                    'Select a camera:\n\n' + 
                    cameraNames.map((name, index) => `${index + 1}. ${name}`).join('\n') +
                    '\n\nEnter the number of your choice:'
                );
                
                if (selectedIndex && !isNaN(selectedIndex) && selectedIndex > 0 && selectedIndex <= videoDevices.length) {
                    const selectedCamera = videoDevices[selectedIndex - 1];
                    console.log('User selected camera:', selectedCamera.label);
                    
                    // Store the selected camera preference
                    localStorage.setItem('preferredCameraId', selectedCamera.deviceId);
                    
                    // Refresh scanner with new camera
                    refreshScanner();
                }
            } catch (error) {
                console.error('Error showing camera selection:', error);
                alert(getConfig('text.errorShowingCameraSelection', 'Error showing camera selection. Please try refreshing the scanner.'));
            }
        }

        // Check for multiple tabs/windows running the attendant app
        function checkForMultipleInstances() {
            const instanceId = Math.random().toString(36).substr(2, 9);
            const storageKey = 'attendant_app_instance';
            
            // Store this instance ID
            localStorage.setItem(storageKey, instanceId);
            
            // Check for other instances
            const checkInterval = setInterval(() => {
                const storedId = localStorage.getItem(storageKey);
                if (storedId !== instanceId) {
                    console.warn('ðŸš¨ MULTIPLE INSTANCES DETECTED! Another tab/window is running the attendant app');
                    console.warn('This could cause queue conflicts and automatic clearing');
                    clearInterval(checkInterval);
                }
            }, 2000);
            
            // Clean up when this tab closes
            window.addEventListener('beforeunload', () => {
                localStorage.removeItem(storageKey);
            });
            
            console.log(`Attendant app instance ID: ${instanceId}`);
        }

        // Monitor network activity to detect hidden API calls
        function monitorNetworkActivity() {
            // Override fetch to log all API calls
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                const method = args[1]?.method || 'GET';
                
                // Log all API calls
                if (typeof url === 'string' && url.includes('/')) {
                    console.log(`ðŸŒ API Call: ${method} ${url} at ${new Date().toLocaleTimeString()}`);
                }
                
                return originalFetch.apply(this, args);
            };
            
            console.log('Network monitoring enabled - all API calls will be logged');
        }

        // Add debug button to help troubleshoot
        document.addEventListener("DOMContentLoaded", () => {
            // Enable network monitoring
            monitorNetworkActivity();
            
            // Check for multiple instances
            checkForMultipleInstances();
            
            // Initialize scanner when page loads
            initializeScanner();
        });


    </script>
</body>

</html>