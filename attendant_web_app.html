<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Team Member App</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="stylesheet" href="static/style.css">
    <script src="static/config.js"></script>
    <script src="static/site_config.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

</head>

<body>
    <div class="info">
        <h1 id="pageTitle">Venue Entry App</h1>

        <div id="reader"></div>
        <div id="result"></div>

        <div class="status">
            <p><strong id="venueStatusLabel">Venue status:</strong> <span id="venueStatus">Loading...</span></p>
            <p><strong id="queueStatusLabel">Queue status:</strong> <span id="queueStatus">Loading...</span></p>
            <p><strong id="guestCountLabel">Guests in queue:</strong> <span id="guestCount">0</span></p>
            <p><strong id="nextGuestLabel">Next guest:</strong> <span id="nextGuest">Loading..</span><span id="premiumBadge"></span></p>
            <p><strong id="readyPoolLabel">Ready pool:</strong></p>
            <ul id="readyPoolList"></ul>
        </div>

        <button id="advanceBtn" onclick="advanceQueue()"></button>
    </div>
    <script>
        const API_BASE = (window.API_BASE || '').replace(/\/$/, '');
        const api = (path) => `${API_BASE}${path}`;

        async function fetchStatus() {
            try {
                const response = await fetch(api('/status'));
                const data = await response.json();

                document.getElementById('guestCount').textContent = data.queue.length;           
                document.getElementById('queueStatus').textContent = data.is_open ? 'Open' : 'Closed';

                const isFull = data.venue_mode_enabled && data.guests_in_venue >= data.venue_capacity;
                document.getElementById('venueStatus').textContent = isFull ? 'Full' : 'Available';

                const advanceBtn = document.getElementById('advanceBtn');

                const readyPool = Array.isArray(data.ready_pool) ? data.ready_pool : [];

                if (data.queue.length > 0 && !isFull) {
                    const nextGuest = readyPool.length > 0 ? readyPool[0] : data.queue[0];
                    const email = typeof nextGuest === 'object' && nextGuest.email ? nextGuest.email : String(nextGuest);
                    const isPremium = typeof nextGuest === 'object' && nextGuest.premium;

                    document.getElementById('nextGuest').textContent = email;
                    document.getElementById('premiumBadge').textContent = isPremium ? 'Premium' : '';
                    document.getElementById('premiumBadge').className = isPremium ? 'premium-badge' : '';
                    advanceBtn.disabled = false;
                } else {
                    document.getElementById('nextGuest').textContent = 'None';
                    document.getElementById('premiumBadge').textContent = '';
                    document.getElementById('premiumBadge').className = '';
                    advanceBtn.disabled = true;
                }

                const readyPoolList = document.getElementById('readyPoolList');
                readyPoolList.innerHTML = '';
                readyPool.forEach(g => {
                    const li = document.createElement('li');
                    const email = typeof g === 'object' && g.email ? g.email : String(g);
                    li.textContent = email + (g.premium ? ' (Premium)' : '');
                    readyPoolList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }



        async function advanceQueue() {
            try {
                const response = await fetch(api('/advance'), { method: 'POST' });
                if (response.ok) {
                    fetchStatus();
                } else {
                    const error = await response.json();
                    alert(error.detail || "Failed to advance queue.");
                }
            } catch (error) {
                console.error('Error advancing queue:', error);
            }
        }

        // Apply site configuration
        applySiteConfig();
        
        fetchStatus();
        setInterval(fetchStatus, 5000);

        // Apply site configuration to UI elements
        function applySiteConfig() {
            // Branding
            document.title = getConfig('brand.name', 'Venue Entry App');
            
            // Text content
            document.getElementById('pageTitle').textContent = getConfig('text.attendantTitle', 'Venue Entry App');
            document.getElementById('venueStatusLabel').textContent = getConfig('text.venueStatus', 'Venue status:');
            document.getElementById('queueStatusLabel').textContent = getConfig('text.queueStatus', 'Queue status:');
            document.getElementById('guestCountLabel').textContent = getConfig('text.guestCount', 'Guests in queue:');
            document.getElementById('nextGuestLabel').textContent = getConfig('text.nextGuest', 'Next guest:');
            document.getElementById('readyPoolLabel').textContent = getConfig('text.readyPool', 'Ready pool:');
            document.getElementById('advanceBtn').textContent = getConfig('text.removeGuest', 'Remove guest from queue');
            
            // Apply colors if CSS custom properties are supported
            if (CSS.supports('color', 'var(--custom-property)')) {
                document.documentElement.style.setProperty('--primary-color', getConfig('colors.primary', '#007bff'));
                document.documentElement.style.setProperty('--secondary-color', getConfig('colors.secondary', '#6c757d'));
                document.documentElement.style.setProperty('--success-color', getConfig('colors.success', '#28a745'));
                document.documentElement.style.setProperty('--danger-color', getConfig('colors.danger', '#dc3545'));
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            document.getElementById("result").innerText = `Scanned Email: ${decodedText}`;

            try {
                const response = await fetch(api('/scan'), { method: "POST", headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: decodedText }) });
                if (response.ok) {
                    document.getElementById("result").innerText = "Guest scanned";
                } else {
                    const error = await response.json();
                    alert(error.detail || "Failed to scan guest.");
                }
            } catch (err) {
                console.error("Error scanning guest:");
                alert("An error occurred while processing the scan.");
            }

            setTimeout(() => {
                document.getElementById("result").innerText = "";
            }, 2000);

            html5QrcodeScanner.clear();
        }

        document.addEventListener("DOMContentLoaded", () => {
            const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            scanner.render(onScanSuccess);
        });


    </script>
</body>

</html>