<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Team Member App</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="stylesheet" href="static/style.css">
    <script src="static/config.js"></script>
    <script src="static/site_config.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

</head>

<body>
    <div class="info">
        <h1 id="pageTitle">Venue Entry App</h1>

        <div id="reader"></div>
        <div id="scanner-status" style="text-align: center; margin: 10px 0; color: #666; font-size: 0.9rem;">Initializing scanner...</div>
        <div id="result"></div>

        <div class="status">
            <p><strong id="venueStatusLabel">Venue status:</strong> <span id="venueStatus">Loading...</span></p>
            <p><strong id="queueStatusLabel">Queue status:</strong> <span id="queueStatus">Loading...</span></p>
            <p><strong id="guestCountLabel">Guests in queue:</strong> <span id="guestCount">0</span></p>
            <p><strong id="nextGuestLabel">Next guest:</strong> <span id="nextGuest">Loading..</span><span id="premiumBadge"></span></p>
            <p><strong id="readyPoolLabel">Ready pool:</strong></p>
            <ul id="readyPoolList"></ul>
        </div>

        <button id="advanceBtn" onclick="advanceQueue()"></button>
        <button id="refreshScannerBtn" onclick="refreshScanner()" style="margin-left: 10px; background-color: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">Refresh Scanner</button>
    </div>
    <script>
        const API_BASE = (window.API_BASE || '').replace(/\/$/, '');
        const api = (path) => `${API_BASE}${path}`;

        async function fetchStatus() {
            try {
                const response = await fetch(api('/status'));
                const data = await response.json();

                // Fix: Use data.queue.length instead of data.queue.length
                document.getElementById('guestCount').textContent = data.queue ? data.queue.length : 0;           
                document.getElementById('queueStatus').textContent = data.is_open ? 'Open' : 'Closed';

                const isFull = data.venue_mode_enabled && data.guests_in_venue >= data.venue_capacity;
                document.getElementById('venueStatus').textContent = isFull ? 'Full' : 'Available';

                const advanceBtn = document.getElementById('advanceBtn');

                const readyPool = Array.isArray(data.ready_pool) ? data.ready_pool : [];

                if (data.queue && data.queue.length > 0 && !isFull) {
                    const nextGuest = readyPool.length > 0 ? readyPool[0] : data.queue[0];
                    const email = typeof nextGuest === 'object' && nextGuest.email ? nextGuest.email : String(nextGuest);
                    const isPremium = typeof nextGuest === 'object' && nextGuest.premium;

                    document.getElementById('nextGuest').textContent = email;
                    document.getElementById('premiumBadge').textContent = isPremium ? 'Premium' : '';
                    document.getElementById('premiumBadge').className = isPremium ? 'premium-badge' : '';
                    advanceBtn.disabled = false;
                } else {
                    document.getElementById('nextGuest').textContent = 'None';
                    document.getElementById('premiumBadge').textContent = '';
                    document.getElementById('premiumBadge').className = '';
                    advanceBtn.disabled = true;
                }

                const readyPoolList = document.getElementById('readyPoolList');
                readyPoolList.innerHTML = '';
                readyPool.forEach(g => {
                    const li = document.createElement('li');
                    const email = typeof g === 'object' && g.email ? g.email : String(g);
                    li.textContent = email + (g.premium ? ' (Premium)' : '');
                    readyPoolList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching status:', error);
                // Set default values on error
                document.getElementById('guestCount').textContent = 'Error';
                document.getElementById('queueStatus').textContent = 'Error';
                document.getElementById('venueStatus').textContent = 'Error';
                document.getElementById('nextGuest').textContent = 'Error';
            }
        }



        async function advanceQueue() {
            try {
                const response = await fetch(api('/advance'), { method: 'POST' });
                if (response.ok) {
                    fetchStatus();
                } else {
                    const error = await response.json();
                    alert(error.detail || "Failed to advance queue.");
                }
            } catch (error) {
                console.error('Error advancing queue:', error);
                alert("Network error occurred while advancing queue.");
            }
        }

        // Apply site configuration
        applySiteConfig();
        
        fetchStatus();
        setInterval(fetchStatus, 5000);

        // Apply site configuration to UI elements
        function applySiteConfig() {
            // Branding
            document.title = getConfig('brand.name', 'Venue Entry App');
            
            // Text content
            document.getElementById('pageTitle').textContent = getConfig('text.attendantTitle', 'Venue Entry App');
            document.getElementById('venueStatusLabel').textContent = getConfig('text.venueStatus', 'Venue status:');
            document.getElementById('queueStatusLabel').textContent = getConfig('text.queueStatus', 'Queue status:');
            document.getElementById('guestCountLabel').textContent = getConfig('text.guestCount', 'Guests in queue:');
            document.getElementById('nextGuestLabel').textContent = getConfig('text.nextGuest', 'Next guest:');
            document.getElementById('readyPoolLabel').textContent = getConfig('text.readyPool', 'Ready pool:');
            document.getElementById('advanceBtn').textContent = getConfig('text.removeGuest', 'Remove guest from queue');
            
            // Apply colors if CSS custom properties are supported
            if (CSS.supports('color', 'var(--custom-property)')) {
                document.documentElement.style.setProperty('--primary-color', getConfig('colors.primary', '#007bff'));
                document.documentElement.style.setProperty('--secondary-color', getConfig('colors.secondary', '#6c757d'));
                document.documentElement.style.setProperty('--success-color', getConfig('colors.success', '#28a745'));
                document.documentElement.style.setProperty('--danger-color', getConfig('colors.danger', '#dc3545'));
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            // Prevent multiple scans of the same code
            if (window.lastScannedCode === decodedText) {
                console.log('Code already scanned, ignoring duplicate');
                return;
            }
            
            window.lastScannedCode = decodedText;
            
            // Update scanner status
            document.getElementById('scanner-status').textContent = 'Processing scan...';
            document.getElementById('scanner-status').style.color = '#ffc107';
            
            document.getElementById("result").innerText = `Scanned Email: ${decodedText}`;

            try {
                const response = await fetch(api('/scan'), { 
                    method: "POST", 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ email: decodedText }) 
                });
                
                if (response.ok) {
                    document.getElementById("result").innerText = "Guest scanned successfully";
                    // Refresh status after successful scan
                    fetchStatus();
                    
                    // Clear the result after a delay
                    setTimeout(() => {
                        document.getElementById("result").innerText = "";
                        // Reset the last scanned code to allow re-scanning
                        window.lastScannedCode = null;
                    }, 3000);
                } else {
                    const error = await response.json();
                    document.getElementById("result").innerText = `Scan failed: ${error.detail || "Unknown error"}`;
                    
                    // Clear the result after a delay
                    setTimeout(() => {
                        document.getElementById("result").innerText = "";
                        // Reset the last scanned code to allow re-scanning
                        window.lastScannedCode = null;
                    }, 3000);
                }
            } catch (err) {
                console.error("Error scanning guest:", err);
                document.getElementById("result").innerText = "Network error occurred";
                
                // Clear the result after a delay
                setTimeout(() => {
                    document.getElementById("result").innerText = "";
                    // Reset the last scanned code to allow re-scanning
                    window.lastScannedCode = null;
                }, 3000);
            }

            // Stop the scanner temporarily to prevent multiple scans
            if (window.html5QrcodeScanner) {
                try {
                    window.html5QrcodeScanner.clear();
                    // Re-initialize the scanner after a short delay
                    setTimeout(() => {
                        initializeScanner();
                    }, 1000);
                } catch (error) {
                    console.error('Error clearing scanner:', error);
                }
            }
        }

        // Handle scanner errors gracefully
        function handleScannerError(error) {
            console.error('Scanner error:', error);
            const readerElement = document.getElementById("reader");
            
            if (error.name === 'NotAllowedError') {
                readerElement.innerHTML = "<p>Camera access denied. Please allow camera access and refresh the scanner.</p>";
            } else if (error.name === 'NotFoundError') {
                readerElement.innerHTML = "<p>No camera found. Please connect a camera and refresh the scanner.</p>";
            } else if (error.name === 'NotSupportedError') {
                readerElement.innerHTML = "<p>Camera not supported. Please try a different device or browser.</p>";
            } else {
                readerElement.innerHTML = "<p>Scanner error occurred. Please refresh the scanner.</p>";
            }
        }

        // Initialize the QR scanner
        function initializeScanner() {
            try {
                // Update status
                document.getElementById('scanner-status').textContent = 'Initializing scanner...';
                document.getElementById('scanner-status').style.color = '#ffc107';
                
                // Clear any existing scanner content
                const readerElement = document.getElementById("reader");
                readerElement.innerHTML = '';
                
                if (window.html5QrcodeScanner) {
                    // Clean up existing scanner
                    try {
                        window.html5QrcodeScanner.clear();
                        window.html5QrcodeScanner = null;
                    } catch (error) {
                        console.log('Scanner already cleared or null');
                    }
                }
                
                // Small delay to ensure cleanup is complete
                setTimeout(() => {
                    try {
                        const scanner = new Html5QrcodeScanner("reader", { 
                            fps: 10, 
                            qrbox: 250,
                            rememberLastUsedCamera: true,
                            showTorchButtonIfSupported: true
                        });
                        
                        scanner.render(onScanSuccess, handleScannerError);
                        window.html5QrcodeScanner = scanner;
                        console.log('QR Scanner initialized successfully');
                        
                        // Update status to ready
                        document.getElementById('scanner-status').textContent = 'Scanner ready - Point camera at QR code';
                        document.getElementById('scanner-status').style.color = '#28a745';
                    } catch (error) {
                        console.error('Error creating scanner:', error);
                        readerElement.innerHTML = "<p>Error creating QR scanner. Please try refreshing the scanner.</p>";
                        document.getElementById('scanner-status').textContent = 'Scanner error - Please refresh';
                        document.getElementById('scanner-status').style.color = '#dc3545';
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error in scanner initialization:', error);
                document.getElementById("reader").innerHTML = "<p>Error initializing QR scanner. Please refresh the page.</p>";
                document.getElementById('scanner-status').textContent = 'Scanner initialization failed';
                document.getElementById('scanner-status').style.color = '#dc3545';
            }
        }

        function refreshScanner() {
            initializeScanner();
        }

        document.addEventListener("DOMContentLoaded", () => {
            // Initialize scanner when page loads
            initializeScanner();
        });


    </script>
</body>

</html>