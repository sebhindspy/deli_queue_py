
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Guest Queue App</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <div class="container">

        <img src="/static/deliq_placeholder.png" style="max-width: -webkit-fill-available; border-radius: 16px;"><img/>

        <h2>Join the Queue!</h2>

        <p>Join the virtual queue and enjoy our other attractions while you wait or upgrade and skip the line!</p>

        <div class="status">
            <p><strong>The queue is currently </strong> <span id="queueStatus">Loading...</span></p>
            <p><strong>Your position in the queue is </strong> <span id="position">0</span></p>
            <p id="turnMessage"></p>
        </div>
        <div id="qrCodeContainer"></div>
        <input id="email" placeholder="Enter your email" required type="email" />
        <button id="actionBtn">Join queue</button>
        <button id="premiumBtn" onclick="goToPayment()">Skip the Line</button>
    </div>

    <script>
        let inQueue = false;
        let intervalId = null;
        let premiumPurchased = false;

        const emailInput = document.getElementById("email");
        const actionBtn = document.getElementById("actionBtn");
        const premiumBtn = document.getElementById("premiumBtn");
        const queueStatusDiv = document.getElementById("queueStatus");
        const statusDiv = document.querySelector(".status");

        function getEmailFromQuery() {
            const params = new URLSearchParams(window.location.search);
            const emailFromUrl = params.get("email");
            if (emailFromUrl) return emailFromUrl;
            return emailInput ? emailInput.value.trim() : null;
        }

        function hasPaidFlag() {
            const params = new URLSearchParams(window.location.search);
            return params.get("paid") === "true";
        }

        function goToPayment() {
            const email = getEmailFromQuery();
            if (email) {
                window.location.href = `/payment?email=${encodeURIComponent(email)}`;
            } else {
                alert("Missing guest email. Cannot proceed to payment.");
            }
        }

        async function isGuestPremium(email) {
            const res = await fetch("/status");
            const data = await res.json();
            const guest = data.queue.find(g => g.email === email);
            return guest && guest.premium;
        }

        async function upgradeToPremium() {
            const email = getEmailFromQuery();
            if (!email) return;

            if (await isGuestPremium(email)) {
                premiumPurchased = true;
                inQueue = true;
                updateButton();
                premiumBtn.textContent = "Payment Complete";
                premiumBtn.disabled = true;
                statusDiv.querySelector("#turnMessage").textContent = "You are already in the premium queue.";
                startPolling(email);
                return;
            }

            const res = await fetch("/join-premium", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email })
            });

            if (res.ok) {
                premiumPurchased = true;
                inQueue = true;
                updateButton();
                premiumBtn.textContent = "Payment Complete";
                premiumBtn.disabled = true;
                statusDiv.querySelector("#turnMessage").textContent = "You have purchased a One Shot and moved to the front!";
                startPolling(email);
            } else {
                const data = await res.json();
                alert(data.detail || "Unable to purchase One Shot");
            }
        }

        actionBtn.addEventListener("click", () => {
            const email = emailInput.value.trim();
            if (!email) {
                alert("Please enter a valid email");
                return;
            }

            if (!inQueue) {
                joinQueue(email);
            } else {
                leaveQueue(email);
            }
        });

        function joinQueue(email) {
            fetch("/join", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email })
            })
            .then(res => res.json())
            .then(() => {
                inQueue = true;
                updateButton();
                startPolling(email);
            });
        }

        function leaveQueue(email) {
            fetch("/leave", {
                method: "POST",
                headers: { "Content-type": "application/json" },
                body: JSON.stringify({ email })
            })
            .then(res => res.json())
            .then(() => {
                resetGuestState();
            });
        }

        function updateButton() {
            if (inQueue) {
                actionBtn.textContent = "Leave Queue";
                actionBtn.classList.add("leave");
                emailInput.disabled = true;
            } else {
                actionBtn.textContent = "Join Queue";
                actionBtn.classList.remove("leave");
                emailInput.disabled = false;
            }
        }

        function resetGuestState() {
            inQueue = false;
            premiumPurchased = false;
            emailInput.value = "";
            emailInput.disabled = false;
            updateButton();
            statusDiv.querySelector("#turnMessage").textContent = "You have been scanned out of the queue.";
            document.getElementById("qrCodeContainer").innerHTML = "";
            clearInterval(intervalId);
        }

        function startPolling(email) {
            let missedPolls = 0;
            fetchQueueStatus();
            intervalId = setInterval(() => {
                fetch(`/position/${encodeURIComponent(email)}`)
                    .then(res => {
                        if (!res.ok) throw new Error("Guest not found");
                        return res.json();
                    })
                    .then(data => {
                        missedPolls = 0;
                        const positionSpan = document.getElementById("position");
                        const qrContainer = document.getElementById("qrCodeContainer");
                        const turnMessage = document.getElementById("turnMessage");

                        positionSpan.textContent = data.position;

                        const readyPoolSize = data.ready_pool_limit || 0;
                        if ((readyPoolSize > 0 && data.position < readyPoolSize) || (readyPoolSize === 0 && data.position === 0)) {
                            turnMessage.textContent = "It's your turn! Please proceed to the attraction.";
                            qrContainer.innerHTML = "";
                            new QRCode(qrContainer, {
                                text: email,
                                width: 128,
                                height: 128
                            });
                        } else {
                            turnMessage.textContent = "";
                            qrContainer.innerHTML = "";
                        }
                    })
                    .catch(() => {
                        missedPolls++;
                        if (missedPolls >= 2) {
                            resetGuestState();
                        }
                    });

                fetchQueueStatus();
            }, 5000);
        }

        function fetchQueueStatus() {
            fetch("/status")
                .then(res => res.json())
                .then(data => {
                    queueStatusDiv.textContent = ` ${data.is_open ? "Open" : "Closed"}`;
                    if (data.premium_limit && data.queue) {
                        const premiumCount = data.queue.filter(g => g.premium).length;
                        const available = premiumCount < data.premium_limit;
                        premiumBtn.disabled = !available || premiumPurchased;
                        premiumBtn.textContent = available ? `Skip the Line for $${data.one_shot_price}` : "Premium unavailable";
                    }
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            (async function () {
                const emailFromUrl = getEmailFromQuery();
                if (emailFromUrl) {
                    emailInput.value = emailFromUrl;
                }

                fetchQueueStatus();

                if (hasPaidFlag()) {
                    await upgradeToPremium();
                }
            })();
        });
    </script>
</body>
</html>
