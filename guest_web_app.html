
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Guest Queue App</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="stylesheet" href="static/style.css">
    <script src="static/config.js"></script>
    <script src="static/site_config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
    <div class="container">

        <img src="" id="brandLogo" style="max-width: 100%; height: auto; border-radius: 16px;">

        <h2 id="pageTitle">Join the Queue!</h2>

        <p id="pageSubtitle">Join the virtual queue and enjoy our other attractions while you wait or upgrade and skip the line!</p>

        <div class="status">
            <p><strong>The queue is currently </strong> <span id="queueStatus">Loading...</span></p>
            <p><strong>Your position in the queue is </strong> <span id="position">0</span></p>
            <p id="turnMessage"></p>
        </div>
        <div id="qrCodeContainer"></div>
        <input id="email" placeholder="Enter your email" required type="email" />
        <button id="actionBtn" class="btn-primary"></button>
        <button id="premiumBtn" onclick="goToPayment()"></button>
    </div>

    <script>
        const API_BASE = (window.API_BASE || '').replace(/\/$/, '');
        const api = (path) => `${API_BASE}${path}`;

        let inQueue = false;
        let intervalId = null;
        let premiumPurchased = false;

        const emailInput = document.getElementById("email");
        const actionBtn = document.getElementById("actionBtn");
        const premiumBtn = document.getElementById("premiumBtn");
        const queueStatusDiv = document.getElementById("queueStatus");
        const statusDiv = document.querySelector(".status");

        function getEmailFromQuery() {
            const params = new URLSearchParams(window.location.search);
            const emailFromUrl = params.get("email");
            if (emailFromUrl) return emailFromUrl;
            return emailInput ? emailInput.value.trim() : null;
        }

        function hasPaidFlag() {
            const params = new URLSearchParams(window.location.search);
            return params.get("paid") === "true";
        }

        function goToPayment() {
            const email = getEmailFromQuery();
            if (email) {
                window.location.href = `payment_mock.html?email=${encodeURIComponent(email)}`;
            } else {
                alert(getConfig('text.missingGuestEmail', 'Missing guest email. Cannot proceed to payment.'));
            }
        }

        async function isGuestPremium(email) {
            const res = await fetch(api('/status'));
            const data = await res.json();
            const guest = data.queue.find(g => g.email === email);
            return guest && guest.premium;
        }

        async function upgradeToPremium() {
            const email = getEmailFromQuery();
            if (!email) return;

            if (await isGuestPremium(email)) {
                premiumPurchased = true;
                inQueue = true;
                updateButton();
                premiumBtn.textContent = getConfig('text.paymentComplete', 'Payment Complete');
                premiumBtn.disabled = true;
                statusDiv.querySelector("#turnMessage").textContent = getConfig('text.alreadyPremium', 'You are already in the premium queue.');
                startPolling(email);
                return;
            }

            const res = await fetch(api('/join-premium'), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email })
            });

            if (res.ok) {
                premiumPurchased = true;
                inQueue = true;
                updateButton();
                premiumBtn.textContent = getConfig('text.paymentComplete', 'Payment Complete');
                premiumBtn.disabled = true;
                statusDiv.querySelector("#turnMessage").textContent = getConfig('text.premiumPurchased', 'You have purchased a One Shot and moved to the front!');
                startPolling(email);
            } else {
                const data = await res.json();
                alert(data.detail || getConfig('text.unableToPurchase', 'Unable to purchase One Shot'));
            }
        }

        actionBtn.addEventListener("click", () => {
            const email = emailInput.value.trim();
            if (!email) {
                alert(getConfig('text.pleaseEnterValidEmail', 'Please enter a valid email'));
                return;
            }

            if (!inQueue) {
                joinQueue(email);
            } else {
                leaveQueue(email);
            }
        });

        function joinQueue(email) {
            fetch(api('/join'), {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email })
            })
            .then(res => res.json())
            .then(() => {
                inQueue = true;
                updateButton();
                startPolling(email);
            });
        }

        function leaveQueue(email) {
            fetch(api('/leave'), {
                method: "POST",
                headers: { "Content-type": "application/json" },
                body: JSON.stringify({ email })
            })
            .then(res => res.json())
            .then(() => {
                resetGuestState();
            });
        }

        function updateButton() {
            if (inQueue) {
                actionBtn.textContent = getConfig('text.leaveButton', 'Leave Queue');
                actionBtn.classList.add("leave");
                emailInput.disabled = true;
            } else {
                actionBtn.textContent = getConfig('text.joinButton', 'Join Queue');
                actionBtn.classList.remove("leave");
                emailInput.disabled = false;
            }
        }

        function resetGuestState() {
            inQueue = false;
            premiumPurchased = false;
            emailInput.value = "";
            emailInput.disabled = false;
            updateButton();
            statusDiv.querySelector("#turnMessage").textContent = getConfig('text.scannedMessage', 'You have been scanned out of the queue.');
            document.getElementById("qrCodeContainer").innerHTML = "";
            clearInterval(intervalId);
        }

        function startPolling(email) {
            let missedPolls = 0;
            fetchQueueStatus();
            intervalId = setInterval(() => {
                fetch(api(`/position/${encodeURIComponent(email)}`))
                    .then(res => {
                        if (!res.ok) throw new Error("Guest not found");
                        return res.json();
                    })
                    .then(data => {
                        missedPolls = 0;
                        const positionSpan = document.getElementById("position");
                        const qrContainer = document.getElementById("qrCodeContainer");
                        const turnMessage = document.getElementById("turnMessage");

                        positionSpan.textContent = data.position;

                        // Get current queue status to check if guest is in ready pool
                        fetch(api('/status'))
                            .then(res => res.json())
                            .then(statusData => {
                                console.log('Status data for QR logic:', statusData);
                                
                                // Find the current guest in the queue
                                const currentGuest = statusData.queue.find(g => g.email === email);
                                console.log('Current guest data:', currentGuest);
                                
                                if (currentGuest && currentGuest.guest_location === 'ready') {
                                    console.log('Guest is in ready pool, showing QR code');
                                    turnMessage.textContent = getConfig('text.turnMessage', "It's your turn! Please proceed to the attraction.");
                                    qrContainer.innerHTML = "";
                                    new QRCode(qrContainer, {
                                        text: email,
                                        width: 128,
                                        height: 128
                                    });
                                } else {
                                    console.log('Guest is not in ready pool, hiding QR code');
                                    const position = data.position + 1;
                                    turnMessage.textContent = getConfig('text.waitingMessage', `You are in position ${position}. Please wait for your turn.`);
                                    qrContainer.innerHTML = "";
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching status for QR code logic:', error);
                                // Fallback: show QR code if position is 0
                                if (data.position === 0) {
                                    turnMessage.textContent = getConfig('text.turnMessage', "It's your turn! Please proceed to the attraction.");
                                    qrContainer.innerHTML = "";
                                    new QRCode(qrContainer, {
                                        text: email,
                                        width: 128,
                                        height: 128
                                    });
                                }
                            });
                    })
                    .catch(() => {
                        missedPolls++;
                        if (missedPolls >= 2) {
                            resetGuestState();
                        }
                    });

                fetchQueueStatus();
            }, 5000);
        }

        function fetchQueueStatus() {
            fetch(api('/status'))
                .then(res => res.json())
                .then(data => {
                    queueStatusDiv.textContent = ` ${data.is_open ? "Open" : "Closed"}`;
                    
                    // Check if premium access is enabled AND premium limit is >0
                    const premiumAccessEnabled = data.premium_access_enabled && data.premium_limit > 0;
                    
                    if (premiumAccessEnabled && data.queue) {
                        const premiumCount = data.queue.filter(g => g.premium).length;
                        const available = premiumCount < data.premium_limit;
                        premiumBtn.disabled = !available || premiumPurchased;
                        premiumBtn.textContent = available ? `Skip the Line for $${data.one_shot_price}` : "Premium unavailable";
                        premiumBtn.style.display = "block"; // Show the button
                    } else {
                        // Hide the premium button if premium access is disabled or limit is 0
                        premiumBtn.style.display = "none";
                    }
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            (async function () {
                // Load customer configuration first
                await loadCustomerConfig();
                
                // Apply site configuration
                applySiteConfig();
                
                const emailFromUrl = getEmailFromQuery();
                if (emailFromUrl) {
                    emailInput.value = emailFromUrl;
                }

                fetchQueueStatus();

                if (hasPaidFlag()) {
                    await upgradeToPremium();
                }
            })();
        });

        // Load customer configuration if available
        async function loadCustomerConfig() {
            try {
                // Check if there's a customer config in localStorage
                const customerConfigs = Object.keys(localStorage).filter(key => key.endsWith('_config.js'));
                if (customerConfigs.length > 0) {
                    // Load the first available customer config
                    const customerName = customerConfigs[0].replace('_config.js', '');
                    const configContent = localStorage.getItem(customerConfigs[0]);
                    
                    // Extract and apply the SITE_CONFIG
                    const configMatch = configContent.match(/window\.SITE_CONFIG\s*=\s*({[\s\S]*?});/);
                    if (configMatch) {
                        const customerConfig = JSON.parse(configMatch[1]);
                        window.SITE_CONFIG = customerConfig;
                        console.log(`Loaded customer configuration: ${customerName}`);
                    }
                }
            } catch (error) {
                console.error('Error loading customer config:', error);
            }
        }

        // Apply site configuration to UI elements
        function applySiteConfig() {
            // Branding
            document.getElementById('brandLogo').src = getConfig('images.logo', 'static/deliq_placeholder.png');
            document.title = getConfig('brand.name', 'Guest Queue App');
            
            // Text content
            document.getElementById('pageTitle').textContent = getConfig('text.guestTitle', 'Join the Queue!');
            document.getElementById('pageSubtitle').textContent = getConfig('text.guestSubtitle', 'Join the virtual queue and enjoy our other attractions while you wait or upgrade and skip the line!');
            document.getElementById('actionBtn').textContent = getConfig('text.joinButton', 'Join queue');
            document.getElementById('premiumBtn').textContent = getConfig('text.premiumButton', 'Skip the Line');
            
            // Apply colors if CSS custom properties are supported
            if (CSS.supports('color', 'var(--custom-property)')) {
                document.documentElement.style.setProperty('--primary-color', getConfig('colors.primary', '#007bff'));
                document.documentElement.style.setProperty('--secondary-color', getConfig('colors.secondary', '#6c757d'));
                document.documentElement.style.setProperty('--success-color', getConfig('colors.success', '#28a745'));
                document.documentElement.style.setProperty('--danger-color', getConfig('colors.danger', '#dc3545'));
            }
        }
    </script>
</body>
</html>
