<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Queue Status Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/style.css">
    <script src="static/config.js"></script>
    <script src="static/site_config.js"></script>
</head>
<body>
    <div class="container">
        <h2 id="pageTitle">Queue Status Dashboard</h2>
        
        <div class="status">
            <p><strong id="apiBaseLabel">API Base URL:</strong> <span id="apiBase">Loading...</span></p>
            <p><strong id="queueStatusLabel">Queue Status:</strong> <span id="queueStatus">Loading...</span></p>
            <p><strong id="totalGuestsLabel">Total Guests:</strong> <span id="totalGuests">0</span></p>
            <p><strong id="readyPoolLabel">Ready Pool:</strong> <span id="readyPool">Loading...</span></p>
            <p><strong id="venueStatusLabel">Venue Status:</strong> <span id="venueStatus">Loading...</span></p>
            <p><strong id="guestsInVenueLabel">Guests in Venue:</strong> <span id="guestsInVenue">0</span></p>
        </div>

        <div class="queue-list">
            <h3 id="currentQueueLabel">Current Queue</h3>
            <div id="queueList">Loading...</div>
        </div>

        <div class="actions">
            <button onclick="refreshStatus()" id="refreshBtn">Refresh Status</button>
            <button onclick="openAdmin()" id="adminBtn">Open Admin Panel</button>
            <button onclick="openAttendant()" id="attendantBtn">Open Attendant App</button>
            <button onclick="openGuest()" id="guestBtn">Open Guest App</button>
        </div>
    </div>

    <script>
        const API_BASE = (window.API_BASE || '').replace(/\/$/, '');
        const api = (path) => `${API_BASE}${path}`;

        // Display the current API base URL
        document.getElementById('apiBase').textContent = API_BASE || 'Not configured';

        async function fetchStatus() {
            try {
                const response = await fetch(api('/status'));
                if (!response.ok) throw new Error('Failed to fetch status');
                
                const data = await response.json();
                
                // Update status fields
                document.getElementById('queueStatus').textContent = data.is_open ? 'Open' : 'Closed';
                document.getElementById('totalGuests').textContent = data.queue.length;
                document.getElementById('readyPool').textContent = data.ready_pool_limit > 0 ? `${data.ready_pool_limit} guests` : 'Disabled';
                
                const isFull = data.venue_mode_enabled && data.guests_in_venue >= data.venue_capacity;
                document.getElementById('venueStatus').textContent = isFull ? 'Full' : 'Available';
                document.getElementById('guestsInVenue').textContent = data.guests_in_venue;

                // Update queue list
                const queueList = document.getElementById('queueList');
                if (data.queue.length === 0) {
                    queueList.innerHTML = '<p>No guests in queue</p>';
                } else {
                    let queueHtml = '<div>';
                    data.queue.forEach((guest, index) => {
                        const location = guest.guest_location || (index === 0 ? 'ready' : 'in queue');
                        const premium = guest.premium ? ' (Premium)' : '';
                        queueHtml += `<p><strong>Position ${index}:</strong> - <em>${location}</em> ${guest.email}${premium} - ${guest.premium ? 'Premium' : ''}</p>`;
                    });
                    queueHtml += '</div>';
                    queueList.innerHTML = queueHtml;
                }
            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('queueStatus').textContent = 'Error: ' + error.message;
            }
        }

        function refreshStatus() {
            fetchStatus();
        }

        function openAdmin() {
            window.open('admin_control_panel.html', '_blank');
            window.open('attendant_web_app.html', '_blank');
        }

        function openAttendant() {
            window.open('attendant_web_app.html', '_blank');
        }

        function openGuest() {
            window.open('guest_web_app.html', '_blank');
        }

        // Apply site configuration
        applySiteConfig();
        
        // Initial load and auto-refresh every 10 seconds
        fetchStatus();
        setInterval(fetchStatus, 10000);

        // Apply site configuration to UI elements
        function applySiteConfig() {
            // Branding
            document.title = getConfig('brand.name', 'Queue Status Dashboard');
            
            // Text content
            document.getElementById('pageTitle').textContent = getConfig('text.dashboardTitle', 'Queue Status Dashboard');
            document.getElementById('apiBaseLabel').textContent = getConfig('text.apiBase', 'API Base URL:');
            document.getElementById('queueStatusLabel').textContent = getConfig('text.queueStatus', 'Queue Status:');
            document.getElementById('totalGuestsLabel').textContent = getConfig('text.totalGuests', 'Total Guests:');
            document.getElementById('readyPoolLabel').textContent = getConfig('text.readyPoolStatus', 'Ready Pool:');
            document.getElementById('venueStatusLabel').textContent = getConfig('text.venueStatus', 'Venue Status:');
            document.getElementById('guestsInVenueLabel').textContent = getConfig('text.guestsInVenue', 'Guests in Venue:');
            document.getElementById('currentQueueLabel').textContent = getConfig('text.currentQueue', 'Current Queue');
            document.getElementById('refreshBtn').textContent = getConfig('text.refreshStatus', 'Refresh Status');
            document.getElementById('adminBtn').textContent = getConfig('text.openAdmin', 'Open Admin Panel');
            document.getElementById('attendantBtn').textContent = getConfig('text.openAttendant', 'Open Attendant App');
            document.getElementById('guestBtn').textContent = getConfig('text.openGuest', 'Open Guest App');
            
            // Apply colors if CSS custom properties are supported
            if (CSS.supports('color', 'var(--custom-property)')) {
                document.documentElement.style.setProperty('--primary-color', getConfig('colors.primary', '#007bff'));
                document.documentElement.style.setProperty('--secondary-color', getConfig('colors.secondary', '#6c757d'));
                document.documentElement.style.setProperty('--success-color', getConfig('colors.success', '#28a745'));
                document.documentElement.style.setProperty('--danger-color', getConfig('colors.danger', '#dc3545'));
            }
        }
    </script>
</body>
</html>
